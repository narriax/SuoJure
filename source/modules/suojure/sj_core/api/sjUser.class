<?php

/*
 *	CLASS:
 *		sjUser ($uid = null)
 *
 *	PUBLIC FNs:
 *		get_uid()
 *		get_access ($project): rid
 *
 * 	TESTING
 *	- test_load_access($uid_override = null)
 */





class sjUser {
	private $debug_mode = false;
	
	private $uid = null;
	//private $access = array();
	public $username = null;
	public $personas = array();
	
	// constructor ==================================
	function __construct ($uid = null) {
		
		$drupal_user = null;
		if (!isset($uid)) {
			global $user;
			$drupal_user = $user;
		} else {
			$drupal_user =  user_load($uid);
		}
		if (!isset($drupal_user) || !isset($drupal_user->uid)) 
			return;
		
		$this->uid = $drupal_user->uid;
		$this->username = $drupal_user->name;

		$this->load_personas();
		
		// load access to projects
		//$this->load_access();
	}


	// getters ======================================
	
	public function get_uid () {
		return $this->uid;
	}
	
	

	
	
	// access functions =============================
	public function test_load_access ($uid_override = null) {
		if (!module_exists('devel')) {
			drupal_set_message ('test_load_access: turn on Devel to test', 'error');
			return;
		}
		$this->debug_mode = true;
		if (isset($uid_override)) $this->uid = $uid_override;
		//dpm("============== sjUser > test_load_access =============== \n uid = ".$this->uid." \n...running load_access()...\n");
		//$this->load_access();
		$this->debug_mode = false;
	}
	
	// load project access from DB (overwrites existing object data)
	/*
	private function load_access () {
		if ($this->debug_mode) sjl('load_access()', 'trace', 'sjUser');
			
		// reset current object data
		$this->access = array();
		
		// quit if user unknown
		if (!isset($this->uid)) {
			if ($this->debug_mode) sjl('uid=null', 'failure');
			return;
		} elseif ($this->debug_mode) sjl('uid='.$this->uid);

		// construct query
		global $sj_db_tables;
		$q 	= db_select ($sj_db_tables['project_access'],'pa')
			-> fields ('pa', array('project', 'rid'))
			-> condition ('pa.uid', $this->uid);
		if ($this->debug_mode) sjl('fetch access for uid='.$this->uid, 'query', $q);
		
		// execute query
		if ($results = $q->execute() -> fetchAllKeyed(0, 1)) {
			$this->access = $results;
			if ($this->debug_mode) sjl ('access table for uid='.$this->uid, 'array', $this->access);
		} elseif ($this->debug_mode) {
			sjl ('no records were fetched', 'failure');
		}
		if ($this->debug_mode) sjp();
	}
	
	// returns rid for specified project
	public function get_access ($project) {
		// allow admins everything
		global $user;
		if (in_array('administrator', $user->roles)) return array_search('administrator', user_roles());
		
		// for the rest, go off access table
		if (array_key_exists($project, $this->access)) return $this->access[$project];
		else return 0;
	}*/
	
	
	
	// personas ======================================
	
	public function load_personas() {

		$q = db_select('sj_user_prsgroup', 'upg')
		   -> fields('upg', array())
		   -> condition('upg.username', $this->username)
		   -> orderBy('upg.weight');	
		$grps_raw = $q -> execute() -> fetchAll();
		   
		$this->personas = array();
		$this->personas[-1] = new stdClass();
		$this->personas[-1]->id = -1;
		$this->personas[-1]->name = '';
		$this->personas[-1]->members = array();
		foreach ($grps_raw as $r) {
			$this->personas[$r->id]= $r;
			$this->personas[$r->id]->members = array();
		}		   
		   
		$q = db_select('sj_user_persona', 'usp')
		   -> fields('usp', array())
		   -> condition('usp.username', $this->username)
		   -> orderBy('usp.weight');	
		$raw = $q->execute()->fetchAll();

		foreach ($raw as $r) {
			if (!isset($r->grp) || !array_key_exists($r->grp, $this->personas)) {
				$r->grp = -1;
			}				
			
			$this->personas[$r->grp]->members[$r->id] = $r;
		}
	}	

	public function get_default_persona () {
		foreach ($this->personas as $grp => $grpdata) {
			if (empty($grpdata->members)) continue;
			return array_keys($grpdata->members)[0];
		}
		return '';
	}
	
}
